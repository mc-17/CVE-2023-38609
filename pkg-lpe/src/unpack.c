//
//  unpack.c
//  pkg-lpe
//
//  Created by Michael on 24/05/2023.
//

#include "unpack.h"
#include <stdlib.h>
#include <string.h>
#include "logging.h"

char marker[16] = "ABCDABCDABCDABCD";

int Unpack(const char* path){
    int      ret                    =    1;
    int      found                  =    0;
    FILE*     fp_self               =    NULL;
    FILE*     fp_write              =    NULL;
    fpos_t    pkgStart              =    0;
    char      readBuffer[BUFSIZ]    =    {0};
    void*     needle                =    NULL;
    
    if( NULL == path )
    {
        ERROR("no path\n");
        return 1;
    }
    
    SUCCESS("Opening %s\n", path);
    
    fp_self = fopen(path, "rb");
    
    
    if( NULL != fp_self )
    {
        fseek(fp_self, 0, SEEK_END);
        size_t sz = ftell(fp_self);
        fseek(fp_self, 0, SEEK_SET);
        
        SUCCESS("Total %ld bytes\n", sz);
            
        for(int i = 0; i < sz; i+=BUFSIZ)
        {
            // Read BUFSIZ bytes
            fread(readBuffer, 1, BUFSIZ, fp_self);
            
            needle = memmem(readBuffer, BUFSIZ, marker, 16);
            if ( needle )
            {
                SUCCESS("Found marker at %ld - %s\n", (size_t)(needle - i), found ? "package" : "skipping");
                if(found)
                {
                    char header[5] = {0};
                    memcpy(header, needle + sizeof(marker) + 1, 5);
                    if( 0 == strncmp(header, "xar!", 5))
                    {
                        pkgStart = ((int)(needle - ((void*)readBuffer)) + i) + sizeof(marker) + 1;
                        break;
                    }
                }
                found = 1;
            }
        }
        
        if ( !pkgStart )
        {
            ERROR("Failed to find second package header, did you bundle the pkg?\n");
            fclose(fp_self);
            return 1;
        }
        
        if( pkgStart )
        {
            fseek(fp_self, pkgStart, SEEK_SET);
            SUCCESS("package starts at position %lld\n", pkgStart);
            sz -= pkgStart;
            fp_write = fopen(PACKAGE_OUT_PATH, "wb+");
            
            if( NULL == fp_write )
            {
                ERROR("Failed to open package for writing\n");
                fclose(fp_self);
                return 1;
            }
            
            
            void* buffer = malloc(sz);
            
            if( NULL == buffer )
            {
                ERROR("failed to malloc package bytes\n");
                return 1;
            }
            
            size_t packageBytes = fread(buffer, 1, sz, fp_self);
            fclose(fp_self);
            
            
            if( 0 == packageBytes )
            {
                ERROR("Failed to read from self\n");
                fclose(fp_write);
                free( buffer );
                return 1;
            }
            
            
            SUCCESS("Read 0x%lX package bytes\n", packageBytes);
            
            size_t packageBytesWritten = fwrite(buffer, 1, sz, fp_write);
            
            if( packageBytes != packageBytesWritten )
            {
                ERROR("Tried to write %ld package bytes, only wrote %ld\n", packageBytes, packageBytesWritten);
                fclose(fp_write);
                free( buffer );
                return 1;
            }
            
            SUCCESS("Wrote package to file\n");
            free( buffer );
            fclose(fp_write);
            ret = 0;
        }
    }
    
    return ret;
}
