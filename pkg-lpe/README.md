# CVE-2023-38609

Uses MacDirtyCow (CVE-2022-46689) with pkg bug (CVE-2023-38609) to get SIP prompt on Ventura 13.0.1.

Can use pkg bug in isolation up to Ventura 13.5 to go from root to SIP prompt.

## User -> Root

We use CVE-2022-46689 for this to overwrite `/etc/pam.d/sudo` with a hard-coded permissive alternative, making sure to calculate the number of padding bytes required to maintain a legitimate PAM file.

## Root -> SIP

Now we can run `sudo` without a password, we can run `installer` with an Apple-signed package. Due to the signature, this package's scripts are ran by `system_installd`, which provides SIP permissions to child processes.

When the package is installed, it runs a number of scripts, one of which is `AlertAll.sh`:

```
#!/bin/sh
target=$2
pkg=$0

ALERTALL="./Tools/AlertAll.app/Contents/MacOS/AlertAll"
if [ "$USER" = "" ]; then
	USER="root"
fi

if [ -e "/usr/bin/sudo" ]; then
	/usr/bin/sudo -u $USER $ALERTALL $target
else 
	$ALERTALL $target
fi

EXITCODE=$?

exit $EXITCODE
```

As `system_installd`/PackageKit only provides the `$PATH` variable, providing any other malicious value allows us to inject commands into this script.

This alongside a couple of other packages with vulnerable scripts, were disclosed to Apple and assigned `CVE-2023-38609`

To exploit this, we first write a shell script `/tmp/launcher.sh`, which calls `installer` with the `$USER` value `root /tmp/payload.sh`. 

`/tmp/payload.sh` writes out a status file to confirm that exploitation was successful, and then opens a terminal.

## running

```
make
./poc
```

## source

`pam.c` - Write PAM file with required padding

`payload.c` - Launch and write payload script

`unpack.c` - Unpack .pkg file packed into executable during compilation

`vm_unaligned_copy_switch_race.c` - [CVE-2022-46689](https://github.com/zhuowei/MacDirtyCowDemo/)